<%- include('../partials/head', { title: prompt.title, description: prompt.summary }) %>

<div x-data="{ show: false, message: '' }" @copy-success.window="show = true; message = $event.detail; setTimeout(() => show = false, 3000)" x-show="show" x-cloak x-transition class="fixed bottom-10 right-10 z-[120] bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 border border-gray-700">
  <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
  <span class="text-sm font-bold" x-text="message"></span>
</div>

<div x-data="promptEditor()" @keydown.window.cmd.c="copyPromptShortcut($event)" @keydown.window.ctrl.c="copyPromptShortcut($event)" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
  <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-200 p-8 md:p-12 mb-8 relative overflow-hidden ring-1 ring-black/5">
    <div class="flex flex-col md:flex-row justify-between items-start gap-8">
      <div class="flex-grow">
        <div class="flex items-center gap-3 mb-4">
          <a href="/library/category/<%= prompt.category_slug %>" class="text-[10px] font-black uppercase tracking-widest text-indigo-600 bg-indigo-50 px-3 py-1 rounded-md hover:bg-indigo-100 transition"><%= prompt.category_name %></a>
          <a href="/library/model/<%= prompt.engine_slug %>" class="text-[10px] font-black uppercase tracking-widest text-white px-3 py-1 rounded-md transition shadow-sm" style="background-color: <%= prompt.engine_color || '#111827' %>"><%= prompt.engine_name || prompt.target_model %></a>
        </div>
        
        <h1 class="text-4xl font-black text-gray-900 sm:text-5xl tracking-tighter leading-none"><%= prompt.title %></h1>
        
        <% if (prompt.tags && prompt.tags.length > 0) { %>
          <div class="mt-4 flex flex-wrap gap-2">
            <% prompt.tags.forEach(t => { %>
              <a href="/library/tag/<%= t.slug %>" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-2.5 py-1.5 rounded-xl hover:bg-indigo-600 hover:text-white transition-all uppercase tracking-tighter shadow-sm">#<%= t.name %></a>
            <% }) %>
          </div>
        <% } %>

        <% if (prompt.summary) { %>
          <p class="mt-6 text-xl text-gray-500 leading-relaxed max-w-2xl italic font-medium">"<%= prompt.summary %>"</p>
        <% } %>
      </div>
      
      <div class="shrink-0 flex items-center gap-4">
        <button @click="toggleFavorite()" class="p-4 rounded-3xl border-2 transition-all shadow-lg" :class="favorited ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-gray-100 text-gray-300 hover:text-pink-400'">
          <svg class="w-8 h-8" :fill="favorited ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        </button>
        
        <% if (locals.currentUser) { %>
          <form action="/library/<%= prompt.slug %>/remix" method="POST">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="p-4 rounded-3xl bg-gray-900 text-white hover:bg-indigo-600 transition shadow-xl" title="Remix to Private Library">
              <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V9a2 2 0 012-2zm0 0V5a2 2 0 012-2h4a2 2 0 012 2v2M9 17h6m-6-4h6"/></svg>
            </button>
          </form>
        <% } %>
      </div>
    </div>

    <div class="mt-12 pt-8 border-t border-gray-50 flex flex-wrap items-center gap-8 text-sm font-black uppercase tracking-widest text-gray-400">
      <div class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg><%= prompt.views_count %> Views</div>
      <div class="flex items-center gap-4">
        <button @click="vote(1)" :class="liked ? 'bg-green-100 text-green-800 ring-green-200 font-bold' : 'bg-gray-50 text-gray-500'" class="flex items-center gap-2 px-4 py-1.5 rounded-full transition hover:bg-indigo-50">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg>
          <span x-text="upvotes"></span>
          <% if (hasAccess) { %><span class="text-[9px] font-black uppercase bg-indigo-600 text-white px-1.5 rounded-sm ml-1">Verified</span><% } %>
        </button>
      </div>
      <div class="h-4 w-px bg-gray-100"></div>
      <div><%= prompt.remix_count %> Remixes</div>
    </div>
  </div>

  <div class="relative mb-12">
    <h3 class="text-xl font-black text-gray-900 mb-6 uppercase tracking-widest text-[10px] text-gray-400">Personalization Workspace</h3>
    
    <% if (prompt.isUnlocked) { %>
      <div x-show="vars.length > 0" class="bg-gray-900 rounded-[2.5rem] shadow-2xl p-8 md:p-12 mb-8 text-white ring-8 ring-indigo-500/5">
        <div class="grid gap-8 sm:grid-cols-2">
          <template x-for="(v, index) in vars" :key="index">
            <div>
              <label class="block text-[10px] font-black uppercase text-white mb-3 tracking-[0.2em]" x-text="v.label"></label>
              <template x-if="v.type === 'text'">
                <input 
                  type="text" 
                  x-model="v.value" 
                  @input="updatePrompt()" 
                  class="w-full bg-gray-800 border-gray-700 rounded-xl p-4 text-sm text-white focus:ring-2 focus:ring-indigo-500 border transition placeholder-white/50" 
                  :placeholder="'Input ' + v.label + '...'"
                >
              </template>
              <template x-if="v.type === 'select'">
                <select 
                  x-model="v.value" 
                  @change="updatePrompt()" 
                  class="w-full bg-gray-800 border-gray-700 rounded-xl p-4 text-sm text-white focus:ring-2 focus:ring-indigo-500 border"
                >
                  <option value="">Choose option...</option>
                  <template x-for="opt in v.options.list" :key="opt">
                    <option :value="opt" x-text="opt"></option>
                  </template>
                </select>
              </template>
            </div>
          </template>
        </div>
      </div>

      <div class="relative bg-white rounded-[2.5rem] border border-gray-200 shadow-sm overflow-hidden group">
        <button onclick="copyPrompt()" class="absolute top-6 right-6 p-3 bg-white text-gray-400 hover:text-indigo-600 rounded-2xl border border-gray-200 shadow-xl transition-all z-10 opacity-0 group-hover:opacity-100" title="Copy (Cmd+C)" id="copy-btn">
          <svg id="icon-copy" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
          <svg id="icon-check" class="w-6 h-6 hidden text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </button>
        <div id="prompt-display" class="p-10 md:p-14 font-mono text-sm md:text-base leading-relaxed whitespace-pre-wrap text-gray-800 tracking-tight"><%= prompt.content.trim() %></div>
      </div>

      <div class="mt-8 flex justify-start">
        <form action="/library/export/<%= prompt.slug %>" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="variables" :value="JSON.stringify(vars)">
          <button type="submit" class="inline-flex items-center gap-3 bg-gray-900 text-white px-10 py-4 rounded-2xl font-black uppercase tracking-widest text-sm shadow-2xl hover:bg-black transition active:scale-95 group">
            <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-400 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Download Prompt (.txt)
          </button>
        </form>
      </div>

    <% } else { %>
      <div class="bg-white p-12 rounded-[3rem] border border-gray-200 text-gray-300 blur-sm select-none h-96 overflow-hidden leading-loose font-mono tracking-tighter">
        <%= prompt.preview %><br><br><%= prompt.preview %>
      </div>
      <div class="absolute inset-0 flex items-center justify-center z-10">
        <div class="bg-white/95 backdrop-blur-sm p-10 rounded-[3.5rem] shadow-2xl text-center border border-gray-100 max-w-sm ring-1 ring-black/5">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-50 mb-6"><svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div>
          <h3 class="font-bold text-gray-900 text-2xl mb-2 tracking-tight">Access Premium</h3>
          <p class="text-sm text-gray-500 mb-8 leading-relaxed">Unlock variables, exports, and your private library.</p>
          <% if (locals.currentUser) { %>
            <div x-data="{ hasCode: false, provider: 'stripe' }" class="space-y-4">
              <form action="/checkout" method="POST" class="space-y-4">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="provider" :value="provider">
                <div class="grid grid-cols-2 gap-2">
                  <button type="button" @click="provider = 'stripe'" :class="provider === 'stripe' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-600' : 'border-gray-200 text-gray-400'" class="p-2.5 border rounded-xl text-[10px] font-black transition uppercase">Card</button>
                  <button type="button" @click="provider = 'paypal'" :class="provider === 'paypal' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-600' : 'border-gray-200 text-gray-400'" class="p-2.5 border rounded-xl text-[10px] font-black transition uppercase">PayPal</button>
                </div>
                <button type="submit" class="w-full inline-block bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-xl transition active:scale-95">Upgrade Today ($<%= product.priceDecimal %>)</button>
              </form>
            </div>
          <% } else { %>
            <a href="/register" class="w-full inline-block bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-xl transition active:scale-95">Join to Unlock</a>
          <% } %>
        </div>
      </div>
    <% } %>
  </div>

  <% if (prompt.images && prompt.images.length > 0) { %>
    <div class="mt-20 pt-10 border-t border-gray-200">
      <h3 class="text-xl font-bold text-gray-900 mb-8 text-center uppercase tracking-widest text-[10px] text-gray-400">Result Examples</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <% (prompt.images || []).forEach(img => { %>
          <div class="bg-white rounded-[2.5rem] overflow-hidden border border-gray-200 shadow-sm transition hover:shadow-xl ring-1 ring-black/5">
            <img src="<%= img.path %>" class="w-full h-auto object-contain bg-gray-50" loading="lazy">
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

</div>

<script>

  const ORIGINAL_CONTENT = `<%- prompt.isUnlocked ? prompt.content.trim().replace(/`/g, '\\`').replace(/\$/g, '\\$') : '' %>`;
  const INITIAL_VARS = <%- JSON.stringify(prompt.variableSpecs || []) %>;
  const PROMPT_ID = <%= prompt.id %>;

  /**
   * Alpine.js Controller for Prompt IDE
   */
  function promptEditor() {
    return {
      liked: <%= stats.liked %>,
      disliked: <%= stats.disliked %>,
      favorited: <%= stats.favorited %>,
      upvotes: <%= stats.upvotes %>,
      vars: INITIAL_VARS,
      
      init() {
        this.updatePrompt();
      },

      /**
       * Injects current variable values into the displayed prompt text.
       */
      updatePrompt() {
        let updated = ORIGINAL_CONTENT;
        
        this.vars.forEach((v) => {
          const escaped = v.original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(escaped, 'g');
          
          const isEmpty = v.value === '' || v.value === false;
          
          const displayValue = isEmpty 
            ? `<span class="text-indigo-400 font-bold underline decoration-indigo-200 decoration-2 underline-offset-2">${v.original}</span>` 
            : `<span class="bg-yellow-200 text-yellow-900 font-bold px-1.5 py-0.5 rounded shadow-sm ring-1 ring-yellow-300 transition-all">${v.value}</span>`;
          
          updated = updated.replace(regex, displayValue);
        });

        const display = document.getElementById('prompt-display');
        if (display) {
          display.innerHTML = updated;
        }
      },

      /**
       * Keyboard listener for Cmd+C / Ctrl+C
       */
      copyPromptShortcut(e) {
        const isEditing = ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName);
        const hasSelection = window.getSelection().toString();
        const displayExists = !!document.getElementById('prompt-display');

        if (!displayExists || hasSelection || isEditing) {
          return;
        }

        e.preventDefault();
        copyPrompt();
      },

      /**
       * Dispatches vote status to the API.
       */
      async vote(v) {
        try {
          const res = await fetch(`/library/prompts/${PROMPT_ID}/vote`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': '<%= csrfToken %>'
            },
            body: JSON.stringify({ value: v })
          });

          if (res.ok) {
            const data = await res.json();
            this.liked = (data.newStatus === 1);
            this.disliked = (data.newStatus === -1);
            this.upvotes = data.stats.upvotes;
            
            window.dispatchEvent(new CustomEvent('copy-success', { 
              detail: 'Vote saved!' 
            }));
          }
        } catch (err) {
          console.error('VOTE_FAILURE:', err);
        }
      },

      /**
       * Toggles the favorite bookmark status.
       */
      async toggleFavorite() {
        try {
          const res = await fetch(`/library/prompts/${PROMPT_ID}/favorite`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': '<%= csrfToken %>'
            }
          });

          if (res.ok) {
            const data = await res.json();
            this.favorited = data.isFavorited;
            
            const msg = this.favorited ? 'Added to favorites' : 'Removed from favorites';
            window.dispatchEvent(new CustomEvent('copy-success', { detail: msg }));
          }
        } catch (err) {
          console.error('FAVORITE_TOGGLE_FAILURE:', err);
        }
      }
    };
  }

  /**
   * Unified Copy Utility
   */
  function copyPrompt() {
    const display = document.getElementById('prompt-display');
    if (!display) return;

    navigator.clipboard.writeText(display.innerText).then(() => {
      window.dispatchEvent(new CustomEvent('copy-success', { detail: 'Prompt copied!' }));
      
      const btn = document.getElementById('copy-btn');
      const i1 = document.getElementById('icon-copy');
      const i2 = document.getElementById('icon-check');

      if (btn && i1 && i2) {
        i1.classList.add('hidden');
        i2.classList.remove('hidden');

        setTimeout(() => {
          i1.classList.remove('hidden');
          i2.classList.add('hidden');
        }, 2000);
      }
    }).catch(err => {
      console.error('CLIPBOARD_FAILURE:', err);
    });
  }
</script>

<%- include('../partials/foot') %>
